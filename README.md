# Configuring & Testing Syslog

# Server Side Configuration

## 1. Install Syslog

```bash
# Update the package manager
sudo dnf update

# Install syslog-ng with -y flag for automatic yes response to prompts
sudo dnf install syslog-ng -y

# Start the syslog-ng service
sudo systemctl start syslog-ng

# Enable the syslog-ng service to start automatically at boot time
sudo systemctl enable syslog-ng

# Restart the syslog-ng service
sudo systemctl restart syslog-ng

# Check the status of the syslog-ng service
sudo systemctl status syslog-ng

# Check version of syslog-ng
syslog-ng --version
```

## 2. Default syslog-ng configuration file

```bash
sudo vi /etc/syslog-ng/syslog-ng.conf
```

[default syslog-ng.conf](https://gist.github.com/johndstein/c1fe252813e63c6ce3e4)

## 3. Edit configuration file

Syslog configuration file typically consists of 4 main "stanzas" or sections, each with a specific purpose

- **Source**
    - This stanza specifies the source of the log messages that the syslog daemon will receive. The source can be a local application, a remote server, or a network device. This section defines the protocol, port, and IP address of the log source.

<aside>
ðŸ’¡ In this demo we are going to collect logs from the local host so we dont need to touch the source its already configured by the internal() method

</aside>

```bash
source s_sys {
    system();
    internal();
};
```

[syslog-ng Open Source Edition 3.16 - Administration Guide](https://www.syslog-ng.com/technical-documents/doc/syslog-ng-open-source-edition/3.16/administration-guide/24#TOPIC-956474)

- **Destination**
    - This stanza specifies the destination of the log messages, which can be a local file, a remote syslog server, or a combination of both. This section defines the protocol, port, and IP address of the syslog server, as well as the path to the local log file.

```bash
# Custom new destination
destination d_myapp { file("/var/log/myapp"); };
```

- **Filter**
    - This stanza specifies the rules that determine which log messages will be logged and how they will be processed. Filters can be based on various criteria, such as message severity, message content, or message source. This section defines the filter rules and the actions that should be taken when a matching message is received, such as logging to a file or forwarding to a remote syslog server.

```bash
# Custom filter
filter f_myapp { facility(local0) and not level(debug); };
```

<aside>
ðŸ“„ The ***facility*** function will decide the logging level
***level*** is the priority of the log

</aside>

Were going to change the f_default filter to all include debug so we can tell the difference when tailing them.

```bash
filter f_default    { level(debug..emerg) and
                        not (facility(mail)
                       or facility(authpriv)
                        or facility(cron)); };
```

See the documentation below

[syslog-ng Open Source Edition 3.16 - Administration Guide](https://www.syslog-ng.com/technical-documents/doc/syslog-ng-open-source-edition/3.16/administration-guide/53#TOPIC-956585)

- **Log**
    - This stanza specifies the format and content of the log messages that will be generated by the syslog daemon. This section defines the log format, including the timestamp, hostname, message severity, and message content. It also defines any additional fields or metadata that should be included in the log message, such as the facility, process ID, or user ID.

```bash
# Custom Log Mapping 
log { source(s_sys); filter(f_myapp); destination(d_myapp); };
```

### Full syslog-ng.conf file on syslog server

```bash
@version: 3.35
@include "scl.conf"

# syslog-ng configuration file.
#
# This should behave pretty much like the original syslog on RedHat. But
# it could be configured a lot smarter.
#
# See syslog-ng(8) and syslog-ng.conf(5) for more information.
#
# Note: it also sources additional configuration files (*.conf)
#       located in /etc/syslog-ng/conf.d/

options {
    flush_lines (0);
    time_reopen (10);
    log_fifo_size (1000);
    chain_hostnames (off);
    use_dns (no);
    use_fqdn (no);
    create_dirs (no);
    keep_hostname (yes);
};

source s_sys {
    system();
    internal();
};

destination d_cons { file("/dev/console"); };
destination d_mesg { file("/var/log/messages"); };
destination d_auth { file("/var/log/secure"); };
destination d_mail { file("/var/log/maillog" flush_lines(10)); };
destination d_spol { file("/var/log/spooler"); };
destination d_boot { file("/var/log/boot.log"); };
destination d_cron { file("/var/log/cron"); };
destination d_kern { file("/var/log/kern"); };
destination d_mlal { usertty("*"); };

# Custom new destination
destination d_myapp { file("/var/log/myapp"); };

filter f_kernel     { facility(kern); };
filter f_default    { level(debug..emerg) and
                        not (facility(mail)
                        or facility(authpriv)
                        or facility(cron)); };
filter f_auth       { facility(authpriv); };
filter f_mail       { facility(mail); };
filter f_emergency  { level(emerg); };
filter f_news       { facility(uucp) or
                        (facility(news)
                        and level(crit..emerg)); };
filter f_boot   { facility(local7); };
filter f_cron   { facility(cron); };

# Custom filter
filter f_myapp { facility(local0) and not level(debug); };

# Custom Log Mapping 
log { source(s_sys); filter(f_myapp); destination(d_myapp); };

log { source(s_sys); filter(f_kernel); destination(d_kern); };
log { source(s_sys); filter(f_default); destination(d_mesg); };
log { source(s_sys); filter(f_auth); destination(d_auth); };
log { source(s_sys); filter(f_mail); destination(d_mail); };
log { source(s_sys); filter(f_emergency); destination(d_mlal); };
log { source(s_sys); filter(f_news); destination(d_spol); };
log { source(s_sys); filter(f_boot); destination(d_boot); };
log { source(s_sys); filter(f_cron); destination(d_cron); };

# Source additional configuration files (.conf extension only)
@include "/etc/syslog-ng/conf.d/*.conf"

# vim:ft=syslog-ng:ai:si:ts=4:sw=4:et:
```

In the configuration above our filter f_myapp has a facility set to local0 which is equivilant to 16. See the table linked below

[syslog-ng Open Source Edition 3.16 - Administration Guide](https://www.syslog-ng.com/technical-documents/doc/syslog-ng-open-source-edition/3.16/administration-guide/53#filter-facility)

The level() filter accepts the following levels: emerg, alert, crit, err, warning, notice, info, debug. We have it set to accept all logging levels but debug 

```bash
not level(debug)
```

## 4. Install tmux to split the screen

```bash
sudo dnf install tmux
```

### Run tmux

```bash
tmux
```

### Split the screen

```bash
ctrl-b, %
```

### Switch between two terminals

```bash
ctrl-b, <arrow_key>
```

## 5. Tail log file

### Where does syslog-ng store logs?

On my Ubuntu machine, I can see the output atÂ `/var/log/syslog`.

On a RHEL/CentOS machine, the output is found inÂ `/var/log/messages`.

Since we added a custom filter for this path we are going to collect all logs but the debug logs

```bash
sudo tail -f /var/log/myapp
```

You will see all log files in directory

```bash
sudo tail -f /var/log/messages
```

## 6. Use logger to send commands

In your other terminal run these commands

```python
# Info Log goes through
logger -p local0.info "my info log"

# Debug doesnt go through because we set it to not level(debug)
logger -p local0.debug "my debug log" 

# Critical Log goes through
logger -p local0.crit "my critical log"

# Error Log goes through
logger -p local0.error "my info log"

# Warning Log goes through
logger -p local0.warn "my info log"
```

## 7. Python script to test syslog-ng

```bash
vi test-syslog-ng-interactive.py
```

```python
#!/usr/bin/python3
import sys
import syslog
import logging
import logging.handlers

# Set up logger
logger = logging.getLogger("10Ã—13")
logger.setLevel(logging.DEBUG)
handler = logging.handlers.SysLogHandler(address='/dev/log', facility=16)
handler.setLevel(logging.DEBUG)
log_format = logging.Formatter('%(asctime)s %(levelname)s %(message)s')
handler.setFormatter(log_format)
logger.addHandler(handler)

while True:
    # Prompt user for log level and message
    print("Which log level do you want to use?")
    print("1. DEBUG")
    print("2. INFO")
    print("3. WARNING")
    print("4. ERROR")
    print("5. CRITICAL")
    print("6. ALL")
    print("7. Exit Program")
    log_level_choice = int(input())
    log_level = None

    if log_level_choice == 1:
        log_level = "DEBUG"
    elif log_level_choice == 2:
        log_level = "INFO"
    elif log_level_choice == 3:
        log_level = "WARNING"
    elif log_level_choice == 4:
        log_level = "ERROR"
    elif log_level_choice == 5:
        log_level = "CRITICAL"
    elif log_level_choice == 6:
        log_level = "ALL"
    elif log_level_choice == 7:
        print("Goodbye!")
        break
    else:
        print("Invalid choice for log level.")
        continue

    print("What message do you want to log?")
    log_message = input()

    # Log the message at the chosen level(s)
    if log_level == "DEBUG" or log_level == "ALL":
        logger.debug(log_message)
    if log_level == "INFO" or log_level == "ALL":
        logger.info(log_message)
    if log_level == "WARNING" or log_level == "ALL":
        logger.warning(log_message)
    if log_level == "ERROR" or log_level == "ALL":
        logger.error(log_message)
    if log_level == "CRITICAL" or log_level == "ALL":
        logger.critical(log_message)
```

### Make the script executable

```bash
chmod u+x test-syslog-ng-interactive.py
```

### Run it

```bash
./test-syslog-ng-interactive.py
```

### Alternative way to run it

```bash
python test-syslog-ng-interactive.py
```

In your other terminal you should see the logs coming in and can verify the logging level in your syslog-ng config is correct

## 8. Troubleshooting

### To find syntax errors in syslog-ng conf file

```bash
sudo syslog-ng -s -f /etc/syslog-ng/syslog-ng.conf
```

### uninstall/reinstall

```bash
sudo yum remove syslog-ng
sudo yum install syslog-ng
```

### Check if port is open, reload, list

not applicable since we dont have a client sending to syslog yet

```bash
sudo netstat -tulpn | grep 514
firewall-cmd --zone=public --add-port=514/tcp --permanent
firewall-cmd --reload
firewall-cmd --zone=public --list-ports
```